pipeline {
    agent any

    environment {
        VENV_DIR = "${WORKSPACE}/.venv"
    }

    stages {
        stage('Setup') {
            steps {
                echo 'Création de l’environnement virtuel...'
                sh 'python -m venv .venv'
                sh '''
                    .venv/bin/pip install --upgrade pip
                    .venv/bin/pip install -r app/requirements.txt
                    .venv/bin/pip install -r reports/requirements.txt || true
                '''
            }
        }

        stage('Lint') {
            steps {
                echo 'Linting avec flake8...'
                sh '.venv/bin/pip install flake8'
                sh '.venv/bin/flake8 app/ tests/'
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'Exécution des tests unitaires...'
                sh '.venv/bin/pytest tests/ --maxfail=1 --disable-warnings -v'
            }
        }

        stage('Run Selenium Tests') {
            steps {
                echo 'Exécution des tests Selenium...'
                sh '.venv/bin/pytest tests/test_selenium_flask.py -v'
            }
        }

        stage('Report') {
            steps {
                echo 'Génération des rapports (JUnit XML)...'
                sh '.venv/bin/pytest --junitxml=reports/results.xml'
                junit 'reports/results.xml'
            }
        }
    }

    post {
        always {
            echo 'Nettoyage post-build...'
            
        }
        success {
            echo 'Build réussi !'
        }
        failure {
            echo 'Build échoué !'
        }
    }
}
